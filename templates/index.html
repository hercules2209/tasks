{% extends "base.html" %}
{% block content %}

<section id="board" class="board">
  {% for wk, items in weeks.items() %}
  <div class="week-col">
    <h2 class="week-title">Week {{ wk }}</h2>
    <div class="cards">
      {% for t in items %}
      <article class="card {{ t.status }}" data-task-id="{{ t.id }}">
        <header class="card-head">
          <button
            class="check-toggle"
            title="Mark done"
            aria-label="toggle done"
            data-action="toggle-task-status"
          >
            {% if t.status == 'done' %}✓{% else %}&nbsp;{% endif %}
          </button>
          <a class="card-title" href="{{ url_for('task_detail', task_id=t.id) }}">
            {{ t.title }}
          </a>
          <span class="badge prio p{{ t.priority }}">P{{ t.priority }}</span>
          <span class="badge status {{ t.status }}">{{ t.status }}</span>
        </header>

        <div class="card-body">
          <p class="desc">
            {{ (t.description or "")[:160] ~ ("..." if (t.description|length>160) else "") }}
          </p>
          <div class="meta">
            <span>Planned: {{ t.start_date or "—" }} → {{ t.end_date or "—" }}</span>
            <span>Started: {{ t.started_at or "—" }}</span>
            <span>Completed: {{ t.completed_at or "—" }}</span>
            <span>Progress: {{ "%.0f"|format(t.progress) }}%</span>
          </div>
          <div class="progress">
            <div class="bar" style="width: {{ t.progress }}%"></div>
          </div>

          <details>
            <summary>Subtasks</summary>
            <ul class="subtasks">
              {% for st in t.subtasks.order_by(Subtask.id.asc()) %}
              <li data-subtask-id="{{ st.id }}">
                <label>
                  <input
                    class="chk"
                    type="checkbox"
                    {% if st.done %}checked{% endif %}
                    {% if t.status == 'blocked' %}disabled{% endif %}
                    data-action="toggle-subtask"
                  />
                  <span>{{ st.title }}</span>
                </label>
                <button
                  class="sub-del"
                  title="Delete subtask"
                  data-action="delete-subtask"
                  {% if t.status == 'blocked' %}disabled{% endif %}
                >
                  ×
                </button>
              </li>
              {% endfor %}
              <li class="new-subtask">
                <input
                  type="text"
                  placeholder="Add subtask…"
                  data-action="new-subtask-input"
                  {% if t.status == 'blocked' %}disabled{% endif %}
                />
              </li>
            </ul>
          </details>
        </div>
      </article>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<dialog id="create-modal" class="modal">
  <div class="modal-header">
    <h3>Create Task</h3>
    <button id="modal-close" class="modal-close" aria-label="Close">×</button>
  </div>
  <form id="create-task-form" method="dialog" class="modal-content">
    <div class="grid">
      <label for="modal-title">Title</label>
      <label for="modal-week">Week</label>
      <label for="modal-priority">Priority</label>

      <input id="modal-title" name="title" type="text" required minlength="3" />
      <input id="modal-week" name="week" type="number" min="1" step="1" placeholder="Auto" />
      <select id="modal-priority" name="priority">
        <option value="2" selected>Normal</option>
        <option value="1">High</option>
        <option value="3">Low</option>
      </select>

      <label for="modal-desc" class="col-span">Description</label>
      <textarea id="modal-desc" name="description" rows="4" placeholder="Describe the task…" class="col-span"></textarea>

      <label for="modal-subtasks" class="col-span">Subtasks (one per line)</label>
      <textarea id="modal-subtasks" name="subtasks" rows="4" placeholder="- First step&#10;- Second step" class="col-span"></textarea>

      <label for="modal-deps" class="col-span">Dependencies (task IDs, comma separated)</label>
      <input id="modal-deps" name="depends_on" type="text" placeholder="e.g. 1, 3, 8" class="col-span" />
    </div>
    <div class="modal-actions">
      <button type="submit" class="btn-primary">Create</button>
      <button type="button" id="cancel-create">Cancel</button>
    </div>
  </form>
</dialog>

<button id="plus-fab" class="fab" title="Add task" aria-label="Add task">+</button>

<script src="{{ url_for('static', filename='board.js') }}"></script>
{% endblock %}
